<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard – BinWatch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.css" />
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            height: 200vh;
            background-color: #198754;
            color: white;
            padding: 20px;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
        }
        .sidebar a:hover {
            text-decoration: underline;
        }
        .content {
            padding: 20px;
        }
        #heatmap {
            height: 400px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar">
        <h2 class="fw-bold">BinWatch</h2>
        <ul class="list-unstyled">
            <li><a href="index.html">Accueil</a></li>
            <li><a href="analyse.html">Analyse</a></li>
            <li><a href="tri.html">Recherche avancée</a></li>
            <li><a href="map.html">Carte</a></li>
            <li><a href="about.html">À propos</a></li>
            <li><a href="logout.html">Déconnexion</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="content flex-grow-1">
        <h1 class="mb-4">Maire de : <span id="city"></span></h1>
        <h2 class="mb-4">Statistiques</h2>

        <!-- Graph: Evolution of analyzed bins -->
        <div class="mb-5">
            <h3>Évolution des poubelles analysées par jour</h3>
            <canvas id="binsChart" width="400" height="200"></canvas>
        </div>

        <!-- Heatmap: Critical points -->
        <div class="mb-5">
            <h3>Carte des points critiques</h3>
            <div id="heatmap"></div>
        </div>
    </div>
</div>
<footer class="bg-success text-white py-4 text-center">
    &copy; 2025 BinWatch – Tous droits réservés.
</footer>

<script>
    document.getElementById('city').textContent = sessionStorage.getItem('city') || 'Ville inconnue';

    const analysisHistory = JSON.parse(sessionStorage.getItem('analysisHistory')) || [];

    async function getCityCoordinates(city) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&format=json`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                if (!isNaN(lat) && !isNaN(lon)) {
                    return [lat, lon];
                }
            }
            throw new Error('Invalid data received from API');
        } catch (error) {
            console.error('Error fetching city coordinates:', error);
            return [48.8566, 2.3522]; // Default to Paris
        }
    }

    async function getAddressCoordinates(address) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                if (!isNaN(lat) && !isNaN(lon)) {
                    return [lat, lon];
                }
            }
            throw new Error('Invalid data received from API');
        } catch (error) {
            console.error('Error fetching address coordinates:', error);
            return null; // Return null if the address cannot be resolved
        }
    }

    function calculateColor(count) {
        if (count === 1) return '#FFFF00'; // Yellow for 1 report
        if (count === 2) return '#FFCC00'; // Orange-yellow for 2 reports
        if (count === 3) return '#FF9900'; // Orange for 3 reports
        if (count === 4) return '#FF6600'; // Red-orange for 4 reports
        return '#FF0000'; // Red for 5 or more reports
    }

    function calculateRadius(count) {
        return 50 + count * 20; // Base radius + dynamic increase
    }

    (async () => {
        const city = sessionStorage.getItem('city') || 'Paris'; // Default to Paris
        const coordinates = await getCityCoordinates(city);

        if (!coordinates || coordinates.some(coord => isNaN(coord))) {
            console.error('Invalid coordinates, using fallback.');
            return;
        }

        const heatmap = L.map('heatmap').setView(coordinates, 13); // Adjust zoom level for better readability
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(heatmap);

        const locationCounts = {}; // Count occurrences of each location
        for (const { location } of analysisHistory) {
            if (location) {
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            }
        }

        for (const location in locationCounts) {
            let latLng = location.split(',').map(Number); // Check if it's already lat,lng format
            if (latLng.some(isNaN)) {
                latLng = await getAddressCoordinates(location); // Convert address to lat,lng
            }
            if (latLng && !latLng.some(isNaN)) {
                const count = locationCounts[location];
                const radius = calculateRadius(count);
                const color = calculateColor(count);

                L.circle(latLng, {
                    radius: radius,
                    color: color,
                    weight: 1, // Smaller border
                    fillOpacity: 0.7
                }).addTo(heatmap);
            } else {
                console.warn('Invalid location data:', location);
            }
        }
    })();

    const binsPerDay = {};
    analysisHistory.forEach(({ date }) => {
        binsPerDay[date] = (binsPerDay[date] || 0) + 1;
    });

    const sortedDates = Object.keys(binsPerDay).sort((a, b) => new Date(a) - new Date(b));
    const sortedBins = sortedDates.map(date => binsPerDay[date]);

    const binsChartCtx = document.getElementById('binsChart').getContext('2d');
    new Chart(binsChartCtx, {
        type: 'line',
        data: {
            labels: sortedDates,
            datasets: [{
                label: 'Poubelles analysées',
                data: sortedBins,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
</body>
</html>