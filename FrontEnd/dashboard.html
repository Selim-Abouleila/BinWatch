<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard – BinWatch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body{background:#f8f9fa}
        .sidebar{width:200px;min-height:100vh;background:#198754;color:#fff;padding:15px}
        .sidebar a{color:#fff;font-size:.9rem;text-decoration:none}
        .sidebar a:hover{text-decoration:underline}
        .content{padding:15px}
        #heatmap{height:300px}
        .thumbnail{max-height:40px}
    </style>
</head>
<body>
<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar">
        <a href="index.html"><h2 class="fw-bold fs-5">BinWatch</h2></a>
        <ul class="list-unstyled">
            <li><a href="index.html">Accueil</a></li>
            <li><a href="analyse.html">Analyse</a></li>
            <li><a href="tri.html">Recherche avancée</a></li>
            <li><a href="map.html">Carte</a></li>
            <li><a href="about.html">À propos</a></li>
            <li><a href="#" id="logoutBtn">Déconnexion</a></li>
        </ul>
    </div>

    <!-- Main -->
    <div class="content flex-grow-1">
        <h1>Mairie de : <span id="cityName">…</span></h1>

        <div id="noDataMsg" class="alert alert-warning d-none">Pas de données pour cette ville.</div>

        <div id="statsSection" class="d-none">
            <h2 class="mb-3">Statistiques</h2>
            <div class="d-inline-block p-2 bg-success text-white rounded mb-3">
                <span id="resolvedCount" class="fw-bold fs-5">0</span><small>&nbsp;poubelles résolues</small>
            </div>

            <form id="dateFilterForm" class="row g-2 mb-4">
                <div class="col"><input type="date" id="startDate" class="form-control" required></div>
                <div class="col"><input type="date" id="endDate" class="form-control" required></div>
                <div class="col-auto"><button class="btn btn-success">Filtrer</button></div>
            </form>

            <div class="row mb-4">
                <div class="col-md-6"><canvas id="binsChart"></canvas></div>
                <div class="col-md-6"><canvas id="binsPieChart"></canvas></div>
            </div>

            <h3>Carte des points critiques</h3>
            <div id="heatmap" class="mb-4"></div>

            <h3>Poubelles en traitement</h3>
            <table class="table table-bordered table-hover">
                <thead class="table-success">
                <tr><th>Miniature</th><th>Date</th><th>Annotation</th><th>Localisation</th><th>Statut</th></tr>
                </thead>
                <tbody id="processingTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* ---------- Auth helpers ---------- */
    const token = localStorage.getItem('token');
    if(!token){location.href='login.html';}

    document.getElementById('logoutBtn').onclick = e=>{
        e.preventDefault();
        localStorage.removeItem('token');
        location.href='index.html';
    };

    /* ---------- State ---------- */
    let city        = '';
    let cityHistory = [];     // données filtrées par ville
    let fullHistory = [];     // toutes les données
    let binsChart, pieChart, map;

    /* ---------- Fetch city from backend ---------- */
    async function loadCity(){
        const res = await fetch('/me/city',{headers:{Authorization:`Bearer ${token}`}});
        if(!res.ok){throw new Error('Auth/ville error');}
        const {ville} = await res.json();
        city = ville?.trim()||'';
        document.getElementById('cityName').textContent = city||'Inconnue';
    }

    /* ---------- Fetch history ---------- */
    async function loadHistory(){
        const res = await fetch('/history');
        if(!res.ok) throw new Error('History error');
        fullHistory = await res.json();  // [{path,created_at,annotation,location,label}]
    }

    /* ---------- Filter by city ---------- */
    function filterByCity(){
        if(!city) return [];
        return fullHistory.filter(({location})=>
            location && location.toLowerCase().includes(city.toLowerCase()));
    }

    /* ---------- Pie & line charts ---------- */
    function buildCharts(){
        const ctxLine = document.getElementById('binsChart');
        const ctxPie  = document.getElementById('binsPieChart');
        const perDay = {};
        let pleine=0, vide=0;

        cityHistory.forEach(({created_at,annotation})=>{
            const d = created_at.split('T')[0];
            perDay[d]=(perDay[d]||0)+1;
            if((annotation||'').toLowerCase()==='pleine') pleine++; else vide++;
        });
        const labels = Object.keys(perDay).sort();
        const counts = labels.map(d=>perDay[d]);

        if(binsChart) binsChart.destroy();
        binsChart = new Chart(ctxLine,{type:'line',data:{labels,datasets:[{label:'Poubelles',data:counts,borderColor:'#ff6384',backgroundColor:'rgba(255,99,132,.2)'}]}});

        if(pieChart) pieChart.destroy();
        pieChart = new Chart(ctxPie,{type:'pie',data:{labels:['Pleine','Vide'],datasets:[{data:[pleine,vide],backgroundColor:['#ff6384','#36a2eb']}]},
            options:{plugins:{legend:{position:'bottom'}}}});
    }

    /* ---------- Heatmap ---------- */
    async function buildMap(){
        const coords = await cityCoords(city);
        document.getElementById('heatmap').innerHTML=''; // reset div
        map = L.map('heatmap').setView(coords,12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}).addTo(map);

        const counts={};
        cityHistory.forEach(({location})=>{
            if(!location) return;
            counts[location]=(counts[location]||0)+1;
        });

        for(const loc in counts){
            const [lat,lng]=await addrCoords(loc);
            if(!lat) continue;
            L.circle([lat,lng],{radius:50*counts[loc],color:'#ff6633',fillOpacity:.5})
                .addTo(map).bindPopup(`${loc}<br>Occurrences : ${counts[loc]}`);
        }
    }

    async function cityCoords(city){
        const r=await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&format=json`);
        const j=await r.json();
        return j.length?[+j[0].lat,+j[0].lon]:[48.8566,2.3522];
    }
    async function addrCoords(addr){
        const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addr)}&format=json`);
        const j=await r.json();
        return j.length?[+j[0].lat,+j[0].lon]:[null,null];
    }

    /* ---------- Processing table & stats ---------- */
    function buildProcessing(){
        const tbody=document.getElementById('processingTable');
        tbody.innerHTML='';
        const processing=cityHistory.filter(b=>b.label && b.label.includes('processing'));
        processing.forEach(({path,created_at,annotation,location,label})=>{
            tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td><img src="${path}" class="thumbnail img-thumbnail"></td>
        <td>${created_at.split('T')[0]}</td>
        <td>${annotation}</td>
        <td>${location}</td>
        <td>${label}</td>
      </tr>`);
        });
    }

    function updateResolvedCount(){
        const resolved=cityHistory.filter(b=>b.label && b.label.includes('resolved')).length;
        document.getElementById('resolvedCount').textContent=resolved;
    }

    /* ---------- Init ---------- */
    window.addEventListener('load',async()=>{
        try{
            await loadCity();
            await loadHistory();
            cityHistory = filterByCity();

            if(!cityHistory.length){
                document.getElementById('noDataMsg').classList.remove('d-none');
                return;
            }

            document.getElementById('statsSection').classList.remove('d-none');
            buildCharts();
            await buildMap();
            buildProcessing();
            updateResolvedCount();
        }catch(e){
            console.error(e);
            alert('Erreur de chargement du dashboard');
        }
    });

    /* ---------- Date filter ---------- */
    document.getElementById('dateFilterForm').addEventListener('submit',e=>{
        e.preventDefault();
        const sd = document.getElementById('startDate').value;
        const ed = document.getElementById('endDate').value;
        const filtered = cityHistory.filter(({created_at})=>{
            const d=created_at.split('T')[0];
            return d>=sd && d<=ed;
        });
        cityHistory = filtered;
        buildCharts();
        buildProcessing();
        updateResolvedCount();
    });
</script>
</body>
</html>
